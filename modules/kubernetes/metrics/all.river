/*
Module: metrics-all
Description: Wrapper module to include all kubernetes metric modules and use cri parsing
*/
argument "forward_to" {
  // comment = "Must be a list(MetricssReceiver) where collected logs should be forwarded to"
	optional = false
}

// cadvisor arguments
argument "cadvisor" {
  comment = "cAdvisor arguments"
  optional = true
  default = {
    enabled = true,
    job_label = "integrations/kubernetes/cadvisor",
    keep_metrics = "(up|container_(cpu_(cfs_(periods|throttled_periods)_total|usage_seconds_total)|fs_(reads|writes)(_bytes)?_total|memory_(cache|rss|swap|working_set_bytes)|network_(receive|transmit)_(bytes|packets(_dropped)?_total))|machine_memory_bytes)",

  }
}

// grafana agent
argument "agent_enabled" {
  comment = "Whether or not cAdvisor should be enabled"
  optional = true
  default = "false"
}

argument "agent_job_label" {
  comment = "The job label to add for all cadvisor metrics"
  optional = true
  default = "integrations/kubernetes/cadvisor"
}

argument "agent_keep_metrics" {
  comment = "A regex of metrics to keep"
  optional = true
  default = "(up|container_(cpu_(cfs_(periods|throttled_periods)_total|usage_seconds_total)|fs_(reads|writes)(_bytes)?_total|memory_(cache|rss|swap|working_set_bytes)|network_(receive|transmit)_(bytes|packets(_dropped)?_total))|machine_memory_bytes)"
}


argument "git_repo" {
  optional = true
  default = coalesce(env("GIT_REPO"), "https://github.com/grafana/agent-modules.git")
}

argument "git_rev" {
  optional = true
  default = coalesce(env("GIT_REV"), env("GIT_REVISION"), env("GIT_BRANCH"), "main")
}

argument "git_pull_freq" {
  optional = true
  default = "0s"
}

module.git "job_cadvisor" {
  repository = argument.git_repo.value
  revision = argument.git_rev.value
  pull_frequency = argument.git_pull_freq.value
  path = "modules/kubernetes/metrics/jobs/cadvisor.river"

  arguments {
    forward_to = argument.forward_to.value
    enabled = argument.cadvisor_enabled.value
    job_label = argument.cadvisor_job_label.value
    keep_metrics = argument.cadvisor_keep_metrics.value
    scrape_interval = argument.scrape_interval.value
    max_cache_size = argument.max_cache_size.value
    clustering = argument.clustering.value
  }
}
