/*
Module: structured-metadata
Description: This module is responsible for setting structured metadata from extracted fields and labels.
             High-cardinality labels that are not commonly queried can impact the way that queries perform,
             creating unnecessary streams.  This information may or may not be in a log line, but can be
             potentially useful.  Think of the label "pod", this is a very high cardinality label that is
             not commonly queried against but may be needed to filter against occassionally, this should
             be structured metadata.  It should be called near the end of the pipeline before keep labels is applied.
Docs: https://grafana.com/docs/loki/latest/get-started/labels/structured-metadata/
*/
argument "forward_to" {
  // comment = "Must be a list(LogsReceiver) where collected logs should be forwarded to"
  optional = false
}

argument "enable_structured_metadata" {
  // comment = "Whether or not to enable structured metadata, this must be enabled and configured in your Loki cluster for this to work, otherwise will result in an error."
  optional = true
  default = false
}

argument "structured_metadata" {
  optional = true
  // comment = "Map of labels/fields to keep before the log message is written to Loki"
  // Docs: https://grafana.com/docs/agent/next/flow/reference/components/loki.process/#stagestructured_metadata-block
  default = {}
}

export "process" {
  value = loki.process.structured_metadata
}

/*
  Example:
  metadata = {
    // assigns the structured metadata key "pod" to the value of the field/label "pod", same as "pod" = "pod"
    "pod" = "",
    // assigns the structured metadata key "user" to the value of the field/label "username"
    "user" = "username",
  }
*/
loki.process "structured_metadata" {
  forward_to = argument.forward_to.value

  // set a tmp variable on whether to enable structured metadata or not
  stage.labels {
    values = {
      __enable_structured_metadata = format("%s", argument.enable_structured_metadata.value),
    }
  }
  // check to see if structured metadata is enabled, if so set it
  stage.match {
    selector = "{__enable_structured_metadata=\"true\"}"

    stage.structured_metadata {
      values = argument.metadata.value
    }
  }

  // drop the tmp label
  stage.label_drop {
    values = ["__enable_structured_metadata"]
  }

}
